# Database Migration Plan - Branch-Scoped Entities

This document outlines the migration strategy for implementing branch isolation across all business entities.

## Migration Order

Execute migrations in this order to maintain referential integrity:

1. ✅ **branches** (Already exists)
2. ✅ **users** (Add branch_id - Created)
3. **customers** - Customer master data (may be shared or branch-specific)
4. **vehicles** - Vehicle inventory
5. **work_orders** - PMS work orders
6. **warranty_claims** - Warranty management
7. **leads** - Sales leads
8. **test_drives** - Test drive scheduling
9. **sales** - Sales transactions
10. **parts** - Parts inventory
11. **activity_logs** - Audit trail
12. **supervisor_approvals** - Approval workflow

## Standard Branch Column Pattern

All business entities should include:

```php
$table->foreignId('branch_id')
    ->constrained('branches')
    ->onDelete('restrict');
$table->index('branch_id');
```

## Entities Requiring Branch ID

### Core Operations
- **vehicles** - Branch inventory tracking
- **work_orders** - Service operations per branch
- **parts** - Branch stock levels
- **warranty_claims** - Claims per branch

### Sales & Customer
- **customers** - Consider: shared vs branch-specific
- **leads** - Sales opportunities per branch
- **test_drives** - Scheduled at specific branch
- **sales** - Transaction location

### Audit & Compliance
- **activity_logs** - Track which branch
- **supervisor_approvals** - Branch-level approvals
- **compliance_checklists** - Per-branch compliance
- **time_tracking** - User sessions per branch

## Special Considerations

### Customers Table
**Decision Required**: Should customers be:
- **Branch-specific**: Each branch has separate customer records (data isolation)
- **Shared with branch context**: Central customer DB with branch relationship tracking
- **Hybrid**: Master customer + branch-specific interactions

**Recommendation**: Shared customers with branch relationships tracked separately.

```php
// customers table - no branch_id (shared)
// customer_branch_interactions - tracks which branches interacted with customer
```

### Multi-Branch Entities
Some entities may need to support multiple branches:
- **Users**: Primary branch + access to other branches
- **Inventory transfers**: From branch -> To branch
- **Reports**: Aggregate across branches (admin/auditor)

### Data Access Strategy

1. **Single Branch Users** (Sales, Service, Parts staff)
   - See only their branch data
   - BranchScoped trait auto-filters

2. **Multi-Branch Users** (Admin, Auditor)
   - Can access all branches
   - Middleware detects role
   - Global scope skipped

3. **Cross-Branch Operations**
   - Inventory transfers
   - Customer referrals
   - Regional reporting

## Implementation Commands

```bash
# Generate migrations
php artisan make:migration create_vehicles_table
php artisan make:migration create_work_orders_table
php artisan make:migration create_leads_table
php artisan make:migration create_sales_table
php artisan make:migration create_parts_table
php artisan make:migration create_warranty_claims_table
php artisan make:migration create_test_drives_table
php artisan make:migration create_customers_table
php artisan make:migration create_activity_logs_table

# Run migrations
php artisan migrate

# Rollback if needed
php artisan migrate:rollback
```

## Model Implementation Checklist

For each branch-scoped model:

- [ ] Add `use BranchScoped;` trait
- [ ] Add `branch_id` to `$fillable`
- [ ] Create relationship methods if needed
- [ ] Add model to appropriate seeder
- [ ] Create factory with branch assignment
- [ ] Write tests for branch isolation

## Query Examples

```php
// Automatic filtering (for non-admin users)
$vehicles = Vehicle::all(); // Only current user's branch

// Admin - see all branches
$allVehicles = Vehicle::withoutBranchScope()->get();

// Specific branch
$branchVehicles = Vehicle::forBranch($branchId)->get();

// Multiple branches
$regionalVehicles = Vehicle::forBranches([1, 2, 3])->get();
```

## Testing Strategy

1. **Unit Tests**: Verify branch isolation per model
2. **Feature Tests**: Verify users can't access other branch data
3. **Integration Tests**: Cross-branch operations (transfers, reports)
4. **Role Tests**: Admin/auditor can access all branches

## Next Steps

1. Review and approve migration plan
2. Decide on customer table strategy
3. Generate migrations in order
4. Create models with BranchScoped trait
5. Update seeders
6. Create factories
7. Write tests
8. Update controllers to use branch context
